---
title: Logica di controller di test in ASP.NET Core
author: ardalis
description: Informazioni sulla logica di controller di test in ASP.NET Core con Moq e xUnit.
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: mvc/controllers/testing
ms.openlocfilehash: 7f34bc7766b41beafb2a1ee09577109bc1402867
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/19/2018
---
# <a name="testing-controller-logic-in-aspnet-core"></a><span data-ttu-id="15ede-103">Logica di controller di test in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="15ede-103">Testing controller logic in ASP.NET Core</span></span>

<span data-ttu-id="15ede-104">Da [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="15ede-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="15ede-105">Nelle applicazioni ASP.NET MVC controller deve essere piccoli e sono specifici per i problemi dell'interfaccia utente.</span><span class="sxs-lookup"><span data-stu-id="15ede-105">Controllers in ASP.NET MVC apps should be small and focused on user-interface concerns.</span></span> <span data-ttu-id="15ede-106">I controller di grandi dimensioni che gestiscono i problemi dell'interfaccia utente non sono più difficili da testare e gestire.</span><span class="sxs-lookup"><span data-stu-id="15ede-106">Large controllers that deal with non-UI concerns are more difficult to test and maintain.</span></span>

[<span data-ttu-id="15ede-107">Consente di visualizzare o scaricare l'esempio da GitHub</span><span class="sxs-lookup"><span data-stu-id="15ede-107">View or download sample from GitHub</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample)

## <a name="testing-controllers"></a><span data-ttu-id="15ede-108">Controller di test</span><span class="sxs-lookup"><span data-stu-id="15ede-108">Testing controllers</span></span>

<span data-ttu-id="15ede-109">I controller sono una parte essenziale di qualsiasi applicazione ASP.NET MVC di base.</span><span class="sxs-lookup"><span data-stu-id="15ede-109">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="15ede-110">Di conseguenza, è necessario confidenza che si comportano come previsto per l'app.</span><span class="sxs-lookup"><span data-stu-id="15ede-110">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="15ede-111">Test automatizzati possono fornire questo confidenza e consente di rilevare errori prima che raggiungano di produzione.</span><span class="sxs-lookup"><span data-stu-id="15ede-111">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="15ede-112">È importante evitare di inserire inutili responsabilità all'interno dei controller e verificare lo stato attivo al test solo sulle responsabilità di controller.</span><span class="sxs-lookup"><span data-stu-id="15ede-112">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="15ede-113">Logica del controller deve essere minima e non essere incentrata sull'infrastruttura o logica problematiche aziendali (ad esempio, accesso ai dati).</span><span class="sxs-lookup"><span data-stu-id="15ede-113">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="15ede-114">La logica del controller, non il framework di test.</span><span class="sxs-lookup"><span data-stu-id="15ede-114">Test controller logic, not the framework.</span></span> <span data-ttu-id="15ede-115">Test come controller di *si comporta* in base a input valido o non valido.</span><span class="sxs-lookup"><span data-stu-id="15ede-115">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="15ede-116">In base al risultato dell'operazione di business che esegue le risposte di controller di test.</span><span class="sxs-lookup"><span data-stu-id="15ede-116">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="15ede-117">Responsabilità tipiche controller:</span><span class="sxs-lookup"><span data-stu-id="15ede-117">Typical controller responsibilities:</span></span>

* <span data-ttu-id="15ede-118">Verificare `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="15ede-118">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="15ede-119">Restituire una risposta di errore se `ModelState` non è valido.</span><span class="sxs-lookup"><span data-stu-id="15ede-119">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="15ede-120">Recuperare un'entità di business dalla persistenza.</span><span class="sxs-lookup"><span data-stu-id="15ede-120">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="15ede-121">Eseguire un'azione nell'entità di business.</span><span class="sxs-lookup"><span data-stu-id="15ede-121">Perform an action on the business entity.</span></span>
* <span data-ttu-id="15ede-122">Salvare l'entità business per la persistenza.</span><span class="sxs-lookup"><span data-stu-id="15ede-122">Save the business entity to persistence.</span></span>
* <span data-ttu-id="15ede-123">Restituisce un oggetto appropriato `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="15ede-123">Return an appropriate `IActionResult`.</span></span>

## <a name="unit-testing"></a><span data-ttu-id="15ede-124">Testing unità</span><span class="sxs-lookup"><span data-stu-id="15ede-124">Unit testing</span></span>

<span data-ttu-id="15ede-125">[Unit test](https://docs.microsoft.com/dotnet/articles/core/testing/unit-testing-with-dotnet-test) prevede una parte di un'app di test in isolamento dalle relative dipendenze e l'infrastruttura.</span><span class="sxs-lookup"><span data-stu-id="15ede-125">[Unit testing](https://docs.microsoft.com/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involves testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="15ede-126">Quando è sottoposto a test unit test di logica di controller, solo il contenuto di una singola azione, non il comportamento delle dipendenze o di framework stesso.</span><span class="sxs-lookup"><span data-stu-id="15ede-126">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="15ede-127">Come si esegue uno unit test le azioni del controller, assicurarsi di che concentrarsi solo il relativo funzionamento.</span><span class="sxs-lookup"><span data-stu-id="15ede-127">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="15ede-128">Uno unit test controller evita elementi quali [filtri](filters.md), [routing](../../fundamentals/routing.md), o [associazione del modello](../models/model-binding.md).</span><span class="sxs-lookup"><span data-stu-id="15ede-128">A controller unit test avoids things like [filters](filters.md), [routing](../../fundamentals/routing.md), or [model binding](../models/model-binding.md).</span></span> <span data-ttu-id="15ede-129">Per porre l'attenzione sul test solo una cosa, unit test sono in genere semplici da scrivere e rapido per l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="15ede-129">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="15ede-130">È possibile eseguire un set ben scritto di unit test spesso senza quantità di overhead.</span><span class="sxs-lookup"><span data-stu-id="15ede-130">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="15ede-131">Tuttavia, gli unit test non vengono rilevati problemi nell'interazione tra componenti, ovvero lo scopo di [test di integrazione](xref:mvc/controllers/testing#integration-testing).</span><span class="sxs-lookup"><span data-stu-id="15ede-131">However, unit tests do not detect issues in the interaction between components, which is the purpose of [integration testing](xref:mvc/controllers/testing#integration-testing).</span></span>

<span data-ttu-id="15ede-132">Se si sta scrivendo filtri personalizzati, route e così via, si consiglia di unit test di loro, ma non come parte dei test per un'azione del controller specifico.</span><span class="sxs-lookup"><span data-stu-id="15ede-132">If you're writing custom filters, routes, etc, you should unit test them, but not as part of your tests on a particular controller action.</span></span> <span data-ttu-id="15ede-133">Essi devono essere testate in isolamento.</span><span class="sxs-lookup"><span data-stu-id="15ede-133">They should be tested in isolation.</span></span>

> [!TIP]
> <span data-ttu-id="15ede-134">[Creare ed eseguire unit test con Visual Studio](https://docs.microsoft.com/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="15ede-134">[Create and run unit tests with Visual Studio](https://docs.microsoft.com/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="15ede-135">Per illustrare gli unit test, esaminare il seguente controller.</span><span class="sxs-lookup"><span data-stu-id="15ede-135">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="15ede-136">Visualizza un elenco di sessioni di confronto e consente nuove sessioni vengono creati con un POST di confronto:</span><span class="sxs-lookup"><span data-stu-id="15ede-136">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="15ede-137">Il controller di seguito è illustrata la [principio dipendenze esplicite](http://deviq.com/explicit-dependencies-principle/), prevede l'inserimento di dipendenze per fornire un'istanza di `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="15ede-137">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="15ede-138">In questo modo abbastanza semplice eseguire il test con un framework di oggetti fittizi, ad esempio [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="15ede-138">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="15ede-139">Il `HTTP GET Index` non dispone di alcun ciclo o diramazione e solo chiama un metodo.</span><span class="sxs-lookup"><span data-stu-id="15ede-139">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="15ede-140">Per eseguire il test `Index` (metodo), è necessario verificare che un `ViewResult` viene restituito, con un `ViewModel` del repository `List` metodo.</span><span class="sxs-lookup"><span data-stu-id="15ede-140">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="15ede-141">Il `HomeController` `HTTP POST Index` metodo (illustrato in precedenza) è necessario verificare:</span><span class="sxs-lookup"><span data-stu-id="15ede-141">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="15ede-142">Il metodo di azione restituisce una risposta richiesta non valida `ViewResult` con i dati appropriati quando `ModelState.IsValid` è`false`</span><span class="sxs-lookup"><span data-stu-id="15ede-142">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`</span></span>

* <span data-ttu-id="15ede-143">Il `Add` nel repository viene chiamato e un `RedirectToActionResult` viene restituito con gli argomenti appropriati quando `ModelState.IsValid` è true.</span><span class="sxs-lookup"><span data-stu-id="15ede-143">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="15ede-144">Stato del modello non valido può essere testato aggiungendo gli errori utilizzando `AddModelError` come illustrato nel primo test riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="15ede-144">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="15ede-145">Il primo test conferma quando `ModelState` non è valido, lo stesso `ViewResult` viene restituito come per un `GET` richiesta.</span><span class="sxs-lookup"><span data-stu-id="15ede-145">The first test confirms when `ModelState` is not valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="15ede-146">Si noti che il test non tenta di passare in un modello non valido.</span><span class="sxs-lookup"><span data-stu-id="15ede-146">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="15ede-147">Che non funzionerebbe comunque dall'associazione del modello non è in esecuzione (anche se un [test di integrazione](xref:mvc/controllers/testing#integration-testing) utilizzerebbe l'associazione di modelli esercizio).</span><span class="sxs-lookup"><span data-stu-id="15ede-147">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:mvc/controllers/testing#integration-testing) would use exercise model binding).</span></span> <span data-ttu-id="15ede-148">In questo caso, l'associazione di modelli non testato.</span><span class="sxs-lookup"><span data-stu-id="15ede-148">In this case, model binding is not being tested.</span></span> <span data-ttu-id="15ede-149">Queste unità solo test operazioni eseguite dal codice nel metodo di azione.</span><span class="sxs-lookup"><span data-stu-id="15ede-149">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="15ede-150">Il secondo test verifica che, quando `ModelState` è valido, un nuovo `BrainstormSession` viene aggiunto (tramite il repository), e il metodo restituisce un `RedirectToActionResult` con le proprietà previsto.</span><span class="sxs-lookup"><span data-stu-id="15ede-150">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="15ede-151">Chiamate simulate che non sono chiamate sono in genere ignorati, ma chiamante `Verifiable` al termine dell'installazione chiamata consente di verificare il test.</span><span class="sxs-lookup"><span data-stu-id="15ede-151">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="15ede-152">Questa operazione viene eseguita con la chiamata a `mockRepo.Verify`, che avrà esito negativo del test se non è stato chiamato il metodo previsto.</span><span class="sxs-lookup"><span data-stu-id="15ede-152">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method was not called.</span></span>

> [!NOTE]
> <span data-ttu-id="15ede-153">La libreria Moq utilizzata in questo esempio consente facilmente di combinare le simulazioni verificabile, o "strict", con le simulazioni non verificabile (detta anche "libero" mocks o stub).</span><span class="sxs-lookup"><span data-stu-id="15ede-153">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="15ede-154">Altre informazioni, vedere [personalizzazione del comportamento di simulazione con Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="15ede-154">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="15ede-155">Un altro controller nell'app Visualizza le informazioni correlate a una sessione di brainstorming particolare.</span><span class="sxs-lookup"><span data-stu-id="15ede-155">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="15ede-156">Include la logica per gestire i valori di id non valido:</span><span class="sxs-lookup"><span data-stu-id="15ede-156">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[Main](./testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="15ede-157">Azione del controller è tre casi da testare, uno per ogni `return` istruzione:</span><span class="sxs-lookup"><span data-stu-id="15ede-157">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="15ede-158">L'app espone la funzionalità di una web API (un elenco di idee associata a una sessione e un metodo per l'aggiunta di nuove idee a una sessione):</span><span class="sxs-lookup"><span data-stu-id="15ede-158">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

<a name="ideas-controller"></a>

[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="15ede-159">Il `ForSession` il metodo restituisce un elenco di `IdeaDTO` tipi.</span><span class="sxs-lookup"><span data-stu-id="15ede-159">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="15ede-160">Evitare di restituire le entità di dominio aziendali direttamente tramite chiamate API, poiché spesso includono più dati richiede il client API, e vengono inutilmente associare il modello di dominio interno dell'app con l'API Esponi esternamente.</span><span class="sxs-lookup"><span data-stu-id="15ede-160">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="15ede-161">Mapping tra le entità di dominio e i tipi si tornerà in rete può essere eseguito manualmente (utilizzando un LINQ `Select` come illustrato di seguito) o tramite una libreria come [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span><span class="sxs-lookup"><span data-stu-id="15ede-161">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span></span>

<span data-ttu-id="15ede-162">Unit test per il `Create` e `ForSession` metodi API:</span><span class="sxs-lookup"><span data-stu-id="15ede-162">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="15ede-163">Come indicato in precedenza, per testare il comportamento del metodo quando `ModelState` non è valido, aggiungere un errore del modello al controller come parte del test.</span><span class="sxs-lookup"><span data-stu-id="15ede-163">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="15ede-164">Non tentare di test di convalida o modello di associazione del modello negli unit test - test solo il comportamento del metodo di azione se confrontate con un particolare `ModelState` valore.</span><span class="sxs-lookup"><span data-stu-id="15ede-164">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="15ede-165">Il secondo test varia a seconda del repository, restituendo null, pertanto il repository fittizio è configurato per restituire null.</span><span class="sxs-lookup"><span data-stu-id="15ede-165">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="15ede-166">Non è necessario creare un database di prova (in memoria o in caso contrario) e creare una query che restituirà questo risultato: può essere eseguita in una singola istruzione come illustrato.</span><span class="sxs-lookup"><span data-stu-id="15ede-166">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="15ede-167">L'ultima verifica che il repository `Update` metodo viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="15ede-167">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="15ede-168">Come è stato fatto in precedenza, la simulazione viene chiamata con `Verifiable` e quindi simulati del repository `Verify` metodo viene chiamato per confermare che è stato eseguito il metodo verificabile.</span><span class="sxs-lookup"><span data-stu-id="15ede-168">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="15ede-169">Non è una responsabilità di unit test per verificare che il `Update` metodo salvati i dati, che può essere eseguita con un test di integrazione.</span><span class="sxs-lookup"><span data-stu-id="15ede-169">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="integration-testing"></a><span data-ttu-id="15ede-170">Test di integrazione</span><span class="sxs-lookup"><span data-stu-id="15ede-170">Integration testing</span></span>

<span data-ttu-id="15ede-171">[Test di integrazione](../../testing/integration-testing.md) viene eseguita per assicurare correttamente insieme di moduli separati all'interno del lavoro di app.</span><span class="sxs-lookup"><span data-stu-id="15ede-171">[Integration testing](../../testing/integration-testing.md) is done to ensure separate modules within your app work correctly together.</span></span> <span data-ttu-id="15ede-172">In generale, qualsiasi che è possibile verificare con uno unit test, è anche possibile testare con un test di integrazione, ma non accade il contrario.</span><span class="sxs-lookup"><span data-stu-id="15ede-172">Generally, anything you can test with a unit test, you can also test with an integration test, but the reverse isn't true.</span></span> <span data-ttu-id="15ede-173">Tuttavia, i test di integrazione tendono a essere molto più lento rispetto agli unit test.</span><span class="sxs-lookup"><span data-stu-id="15ede-173">However, integration tests tend to be much slower than unit tests.</span></span> <span data-ttu-id="15ede-174">Pertanto, è consigliabile testare qualsiasi è possibile con gli unit test e usare i test di integrazione per scenari che coinvolgono più collaboratori.</span><span class="sxs-lookup"><span data-stu-id="15ede-174">Thus, it's best to test whatever you can with unit tests, and use integration tests for scenarios that involve multiple collaborators.</span></span>

<span data-ttu-id="15ede-175">Sebbene potrebbero comunque essere utile, oggetti fittizi utilizzati raramente nei test di integrazione.</span><span class="sxs-lookup"><span data-stu-id="15ede-175">Although they may still be useful, mock objects are rarely used in integration tests.</span></span> <span data-ttu-id="15ede-176">Gli unit test, oggetti fittizi di un metodo efficace per controllare il comportamento collaboratori all'esterno dell'unità testato ai fini del test.</span><span class="sxs-lookup"><span data-stu-id="15ede-176">In unit testing, mock objects are an effective way to control how collaborators outside of the unit being tested should behave for the purposes of the test.</span></span> <span data-ttu-id="15ede-177">In un test di integrazione, collaboratori reali vengono utilizzati per confermare che l'intero sottosistema insieme funziona correttamente.</span><span class="sxs-lookup"><span data-stu-id="15ede-177">In an integration test, real collaborators are used to confirm the whole subsystem works together correctly.</span></span>

### <a name="application-state"></a><span data-ttu-id="15ede-178">Stato dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="15ede-178">Application state</span></span>

<span data-ttu-id="15ede-179">Una considerazione importante quando si esegue il test di integrazione viene illustrato come impostare lo stato dell'app.</span><span class="sxs-lookup"><span data-stu-id="15ede-179">One important consideration when performing integration testing is how to set your app's state.</span></span> <span data-ttu-id="15ede-180">I test devono essere eseguiti indipendenti una da altra, e pertanto, ogni test deve iniziare con l'app in uno stato noto.</span><span class="sxs-lookup"><span data-stu-id="15ede-180">Tests need to run independent of one another, and so each test should start with the app in a known state.</span></span> <span data-ttu-id="15ede-181">Se l'app non utilizzare un database o disporre di persistenza, non è possibile un problema.</span><span class="sxs-lookup"><span data-stu-id="15ede-181">If your app doesn't use a database or have any persistence, this may not be an issue.</span></span> <span data-ttu-id="15ede-182">Tuttavia, la maggior parte delle applicazioni reali mantenere il loro stato a un tipo di archivio dati, pertanto le modifiche apportate da un test potrebbe influire su un altro test a meno che non viene reimpostato l'archivio dati.</span><span class="sxs-lookup"><span data-stu-id="15ede-182">However, most real-world apps persist their state to some kind of data store, so any modifications made by one test could impact another test unless the data store is reset.</span></span> <span data-ttu-id="15ede-183">Utilizza il programma `TestServer`, è molto semplice per le applicazioni ASP.NET Core host all'interno di questo test di integrazione, ma che non necessariamente concedere l'accesso ai dati verrà utilizzato.</span><span class="sxs-lookup"><span data-stu-id="15ede-183">Using the built-in `TestServer`, it's very straightforward to host ASP.NET Core apps within our integration tests, but that doesn't necessarily grant access to the data it will use.</span></span> <span data-ttu-id="15ede-184">Se si utilizza un database effettivo, è possibile che l'app di connettersi a un database di test, che i test possono accedere e verificare viene reimpostati su uno stato noto prima dell'esecuzione di ogni test.</span><span class="sxs-lookup"><span data-stu-id="15ede-184">If you're using an actual database, one approach is to have the app connect to a test database, which your tests can access and ensure is reset to a known state before each test executes.</span></span>

<span data-ttu-id="15ede-185">In questa applicazione di esempio, si sta utilizzando il supporto di InMemoryDatabase del Core di Entity Framework, in modo non è possibile connettersi ad esso solo da un progetto di test.</span><span class="sxs-lookup"><span data-stu-id="15ede-185">In this sample application, I'm using Entity Framework Core's InMemoryDatabase support, so I can't just connect to it from my test project.</span></span> <span data-ttu-id="15ede-186">Invece, espongono un `InitializeDatabase` metodo l'app `Startup` (classe), che viene chiamato quando viene avviata l'app se si trova nel `Development` ambiente.</span><span class="sxs-lookup"><span data-stu-id="15ede-186">Instead, I expose an `InitializeDatabase` method from the app's `Startup` class, which I call when the app starts up if it's in the `Development` environment.</span></span> <span data-ttu-id="15ede-187">Il test di integrazione di trarre vantaggio automaticamente da questo, purché l'ambiente è impostato su `Development`.</span><span class="sxs-lookup"><span data-stu-id="15ede-187">My integration tests automatically benefit from this as long as they set the environment to `Development`.</span></span> <span data-ttu-id="15ede-188">Non è necessario preoccuparsi di ripristino del database, poiché il InMemoryDatabase viene reimpostato ogni volta che l'app viene riavviata.</span><span class="sxs-lookup"><span data-stu-id="15ede-188">I don't have to worry about resetting the database, since the InMemoryDatabase is reset each time the app restarts.</span></span>

<span data-ttu-id="15ede-189">La `Startup` classe:</span><span class="sxs-lookup"><span data-stu-id="15ede-189">The `Startup` class:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Startup.cs?highlight=19,20,34,35,43,52)]

<span data-ttu-id="15ede-190">Verrà visualizzato il `GetTestSession` metodo usata di frequente nei test di integrazione riportati di seguito.</span><span class="sxs-lookup"><span data-stu-id="15ede-190">You'll see the `GetTestSession` method used frequently in the integration tests below.</span></span>

### <a name="accessing-views"></a><span data-ttu-id="15ede-191">Accesso alle visualizzazioni</span><span class="sxs-lookup"><span data-stu-id="15ede-191">Accessing views</span></span>

<span data-ttu-id="15ede-192">Ogni classe di test di integrazione consente di configurare il `TestServer` che eseguirà l'app ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="15ede-192">Each integration test class configures the `TestServer` that will run the ASP.NET Core app.</span></span> <span data-ttu-id="15ede-193">Per impostazione predefinita, `TestServer` ospita l'app web nella cartella in cui è in esecuzione, in questo caso, la cartella di progetto di test.</span><span class="sxs-lookup"><span data-stu-id="15ede-193">By default, `TestServer` hosts the web app in the folder where it's running - in this case, the test project folder.</span></span> <span data-ttu-id="15ede-194">Pertanto, quando si tenta di verificare le azioni del controller che restituiscono `ViewResult`, potrebbe essere visualizzato questo errore:</span><span class="sxs-lookup"><span data-stu-id="15ede-194">Thus, when you attempt to test controller actions that return `ViewResult`, you may see this error:</span></span>

```
The view 'Index' was not found. The following locations were searched:
(list of locations)
```

<span data-ttu-id="15ede-195">Per risolvere questo problema, è necessario configurare radice del contenuto del server, in modo da consentirne l'individuazione le viste per il progetto sottoposto a test.</span><span class="sxs-lookup"><span data-stu-id="15ede-195">To correct this issue, you need to configure the server's content root, so it can locate the views for the project being tested.</span></span> <span data-ttu-id="15ede-196">Questa operazione viene eseguita da una chiamata a `UseContentRoot` nel `TestFixture` (classe), illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="15ede-196">This is done by a call to `UseContentRoot` in the `TestFixture` class, shown below:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/TestFixture.cs?highlight=30,33)]

<span data-ttu-id="15ede-197">Il `TestFixture` classe è responsabile della configurazione e la creazione di `TestServer`, impostare un `HttpClient` per comunicare con il `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="15ede-197">The `TestFixture` class is responsible for configuring and creating the `TestServer`, setting up an `HttpClient` to communicate with the `TestServer`.</span></span> <span data-ttu-id="15ede-198">Ogni dell'integrazione di test Usa il `Client` proprietà per connettersi al server di prova e di effettuare una richiesta.</span><span class="sxs-lookup"><span data-stu-id="15ede-198">Each of the integration tests uses the `Client` property to connect to the test server and make a request.</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/HomeControllerTests.cs?highlight=20,26,29,30,31,35,38,39,40,41,44,47,48)]

<span data-ttu-id="15ede-199">Il primo test precedente, il `responseString` contiene l'effettivo eseguito il rendering HTML dalla visualizzazione, che può essere controllata per verificare contenga i risultati previsti.</span><span class="sxs-lookup"><span data-stu-id="15ede-199">In the first test above, the `responseString` holds the actual rendered HTML from the View, which can be inspected to confirm it contains expected results.</span></span>

<span data-ttu-id="15ede-200">Il secondo test costruisce un POST form con un nome univoco della sessione e invia all'app, quindi verifica che venga restituito il reindirizzamento previsto.</span><span class="sxs-lookup"><span data-stu-id="15ede-200">The second test constructs a form POST with a unique session name and POSTs it to the app, then verifies that the expected redirect is returned.</span></span>

### <a name="api-methods"></a><span data-ttu-id="15ede-201">Metodi dell'API</span><span class="sxs-lookup"><span data-stu-id="15ede-201">API methods</span></span>

<span data-ttu-id="15ede-202">Se l'app espone web API, è consigliabile automatizzare i test conferma vengono eseguiti come previsto.</span><span class="sxs-lookup"><span data-stu-id="15ede-202">If your app exposes web APIs, it's a good idea to have automated tests confirm they execute as expected.</span></span> <span data-ttu-id="15ede-203">L'elemento predefinito `TestServer` semplifica l'API web di test.</span><span class="sxs-lookup"><span data-stu-id="15ede-203">The built-in `TestServer` makes it easy to test web APIs.</span></span> <span data-ttu-id="15ede-204">Se i metodi API utilizza l'associazione di modelli, è necessario controllare sempre `ModelState.IsValid`, e i test di integrazione sono il posto giusto per confermare che la convalida del modello funzioni correttamente.</span><span class="sxs-lookup"><span data-stu-id="15ede-204">If your API methods are using model binding, you should always check `ModelState.IsValid`, and integration tests are the right place to confirm that your model validation is working properly.</span></span>

<span data-ttu-id="15ede-205">Il seguente set di test di `Create` metodo il [IdeasController](xref:mvc/controllers/testing#ideas-controller) classe illustrato in precedenza:</span><span class="sxs-lookup"><span data-stu-id="15ede-205">The following set of tests target the `Create` method in the [IdeasController](xref:mvc/controllers/testing#ideas-controller) class shown above:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/ApiIdeasControllerTests.cs)]

<span data-ttu-id="15ede-206">A differenza dei test di integrazione delle azioni che restituisce viste HTML, i metodi API web che restituiscono risultati in genere possibile deserializzati come oggetti fortemente tipizzati, come illustrato sopra l'ultimo test.</span><span class="sxs-lookup"><span data-stu-id="15ede-206">Unlike integration tests of actions that returns HTML views, web API methods that return results can usually be deserialized as strongly typed objects, as the last test above shows.</span></span> <span data-ttu-id="15ede-207">In questo caso, il test deserializza il risultato a un `BrainstormSession` istanza e conferma che l'idea è stato aggiunto correttamente alla relativa raccolta di idee.</span><span class="sxs-lookup"><span data-stu-id="15ede-207">In this case, the test deserializes the result to a `BrainstormSession` instance, and confirms that the idea was correctly added to its collection of ideas.</span></span>

<span data-ttu-id="15ede-208">In questo articolo sono disponibili esempi aggiuntivi di test di integrazione [progetto di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span><span class="sxs-lookup"><span data-stu-id="15ede-208">You'll find additional examples of integration tests in this article's [sample project](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span></span>
