---
title: Dependency Injection in ASP.NET Core
author: ardalis
description: Informazioni su come ASP.NET Core implementa l'inserimento di dipendenze e come utilizzarla.
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: fundamentals/dependency-injection
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 1da3d557c48921747634b08cedb518184fb5f963
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/19/2018
---
# <a name="introduction-to-dependency-injection-in-aspnet-core"></a><span data-ttu-id="22344-103">Introduzione a Dependency Injection in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="22344-103">Introduction to Dependency Injection in ASP.NET Core</span></span>

<a name="fundamentals-dependency-injection"></a>

<span data-ttu-id="22344-104">Da [Steve Smith](https://ardalis.com/) e [Scott Addie](https://scottaddie.com)</span><span class="sxs-lookup"><span data-stu-id="22344-104">By [Steve Smith](https://ardalis.com/) and [Scott Addie](https://scottaddie.com)</span></span>

<span data-ttu-id="22344-105">ASP.NET Core è progettato da zero per supportare e sfruttare l'inserimento di dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-105">ASP.NET Core is designed from the ground up to support and leverage dependency injection.</span></span> <span data-ttu-id="22344-106">Applicazioni ASP.NET Core possono sfruttare servizi framework incorporato, poiché questi vengono inseriti in metodi della classe di avvio, e i servizi delle applicazioni possono essere configurati per l'attacco intrusivo nel codice anche.</span><span class="sxs-lookup"><span data-stu-id="22344-106">ASP.NET Core applications can leverage built-in framework services by having them injected into methods in the Startup class, and application services can be configured for injection as well.</span></span> <span data-ttu-id="22344-107">Il contenitore dei servizi predefiniti fornito da ASP.NET Core fornisce una funzionalità minima impostato e non è destinata a sostituire altri contenitori.</span><span class="sxs-lookup"><span data-stu-id="22344-107">The default services container provided by ASP.NET Core provides a minimal feature set and is not intended to replace other containers.</span></span>

<span data-ttu-id="22344-108">[Visualizzare o scaricare il codice di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([procedura per il download](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="22344-108">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/dependency-injection/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="what-is-dependency-injection"></a><span data-ttu-id="22344-109">Che cos'è l'inserimento di dipendenze?</span><span class="sxs-lookup"><span data-stu-id="22344-109">What is Dependency Injection?</span></span>

<span data-ttu-id="22344-110">Inserimento di dipendenze (DI) è una tecnica per l'implementazione dell'accoppiamento debole tra oggetti e i collaboratori o dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-110">Dependency injection (DI) is a technique for achieving loose coupling between objects and their collaborators, or dependencies.</span></span> <span data-ttu-id="22344-111">Anziché creare direttamente un'istanza di collaboratori o utilizzando i riferimenti statici, per la classe in qualche modo sono disponibili gli oggetti di cui necessita di una classe per eseguire le azioni.</span><span class="sxs-lookup"><span data-stu-id="22344-111">Rather than directly instantiating collaborators, or using static references, the objects a class needs in order to perform its actions are provided to the class in some fashion.</span></span> <span data-ttu-id="22344-112">In genere, le classi verranno dichiarare le relative dipendenze attraverso il relativo costruttore, consentendo loro di seguire il [principio dipendenze esplicite](http://deviq.com/explicit-dependencies-principle/).</span><span class="sxs-lookup"><span data-stu-id="22344-112">Most often, classes will declare their dependencies via their constructor, allowing them to follow the [Explicit Dependencies Principle](http://deviq.com/explicit-dependencies-principle/).</span></span> <span data-ttu-id="22344-113">Questo approccio è noto come "inserimento del costruttore".</span><span class="sxs-lookup"><span data-stu-id="22344-113">This approach is known as "constructor injection".</span></span>

<span data-ttu-id="22344-114">Quando le classi sono dotate DI ricordare, essi sono più loosely coupled perché non presentano dipendenze dirette, hardcoded i collaboratori.</span><span class="sxs-lookup"><span data-stu-id="22344-114">When classes are designed with DI in mind, they are more loosely coupled because they do not have direct, hard-coded dependencies on their collaborators.</span></span> <span data-ttu-id="22344-115">Questo concetto segue il [principio di inversione dipendenza](http://deviq.com/dependency-inversion-principle/), che indica che *"moduli di livello alti non devono dipendere moduli di livello bassi; entrambi dovrebbero dipendere astrazioni".*</span><span class="sxs-lookup"><span data-stu-id="22344-115">This follows the [Dependency Inversion Principle](http://deviq.com/dependency-inversion-principle/), which states that *"high level modules should not depend on low level modules; both should depend on abstractions."*</span></span> <span data-ttu-id="22344-116">Anziché le implementazioni specifiche di riferimento, classi richiesta astrazioni (in genere `interfaces`) che vengono forniti a tali quando la classe viene costruita.</span><span class="sxs-lookup"><span data-stu-id="22344-116">Instead of referencing specific implementations, classes request abstractions (typically `interfaces`) which are provided to them when the class is constructed.</span></span> <span data-ttu-id="22344-117">L'estrazione delle dipendenze in interfacce fornendo implementazioni di queste interfacce come parametri rappresenta anche un esempio del [progettuale strategia](http://deviq.com/strategy-design-pattern/).</span><span class="sxs-lookup"><span data-stu-id="22344-117">Extracting dependencies into interfaces and providing implementations of these interfaces as parameters is also an example of the [Strategy design pattern](http://deviq.com/strategy-design-pattern/).</span></span>

<span data-ttu-id="22344-118">Quando un sistema è basato sull'uso DI, con molte classi che richiede le relative dipendenze tramite i relativi costruttore (o proprietà), è utile creare una classe dedicata alla creazione di queste classi con le relative dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-118">When a system is designed to use DI, with many classes requesting their dependencies via their constructor (or properties), it's helpful to have a class dedicated to creating these classes with their associated dependencies.</span></span> <span data-ttu-id="22344-119">Queste classi sono definite come *contenitori*, più specificamente, [Inversion of Control (IoC)](http://deviq.com/inversion-of-control/) contenitori o contenitori Dependency Injection (DI).</span><span class="sxs-lookup"><span data-stu-id="22344-119">These classes are referred to as *containers*, or more specifically, [Inversion of Control (IoC)](http://deviq.com/inversion-of-control/) containers or Dependency Injection (DI) containers.</span></span> <span data-ttu-id="22344-120">Un contenitore è essenzialmente una factory che è responsabile di fornire istanze di tipi che vengono richiesti da esso.</span><span class="sxs-lookup"><span data-stu-id="22344-120">A container is essentially a factory that is responsible for providing instances of types that are requested from it.</span></span> <span data-ttu-id="22344-121">Se un determinato tipo è dichiarato che dispone di dipendenze e il contenitore è stato configurato per fornire i tipi di relazione, verrà creato le dipendenze come parte della creazione dell'istanza richiesta.</span><span class="sxs-lookup"><span data-stu-id="22344-121">If a given type has declared that it has dependencies, and the container has been configured to provide the dependency types, it will create the dependencies as part of creating the requested instance.</span></span> <span data-ttu-id="22344-122">In questo modo, è possibile garantire grafici complessi delle dipendenze per le classi senza la necessità di costruzione qualsiasi oggetto a livello di codice.</span><span class="sxs-lookup"><span data-stu-id="22344-122">In this way, complex dependency graphs can be provided to classes without the need for any hard-coded object construction.</span></span> <span data-ttu-id="22344-123">Oltre a creare gli oggetti con le relative dipendenze, contenitori in genere la gestione della durata degli oggetti all'interno dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="22344-123">In addition to creating objects with their dependencies, containers typically manage object lifetimes within the application.</span></span>

<span data-ttu-id="22344-124">ASP.NET Core include un semplice contenitore predefinito (rappresentato dal `IServiceProvider` interface) che supporta l'inserimento del costruttore per impostazione predefinita e ASP.NET rende disponibili tramite DI determinati servizi.</span><span class="sxs-lookup"><span data-stu-id="22344-124">ASP.NET Core includes a simple built-in container (represented by the `IServiceProvider` interface) that supports constructor injection by default, and ASP.NET makes certain services available through DI.</span></span> <span data-ttu-id="22344-125">ASP. Contenitore di rete fa riferimento ai tipi gestiti come *servizi*.</span><span class="sxs-lookup"><span data-stu-id="22344-125">ASP.NET's container refers to the types it manages as *services*.</span></span> <span data-ttu-id="22344-126">Nella parte restante di questo articolo, *servizi* farà riferimento ai tipi gestiti dal contenitore IoC di ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="22344-126">Throughout the rest of this article, *services* will refer to types that are managed by ASP.NET Core's IoC container.</span></span> <span data-ttu-id="22344-127">Si configurano i servizi del contenitore predefinito nel `ConfigureServices` metodo dell'applicazione `Startup` classe.</span><span class="sxs-lookup"><span data-stu-id="22344-127">You configure the built-in container's services in the `ConfigureServices` method in your application's `Startup` class.</span></span>

> [!NOTE]
> <span data-ttu-id="22344-128">Martin Fowler ha scritto un articolo completo su [inversione di contenitori di controlli e il modello di inserimento di dipendenza](https://www.martinfowler.com/articles/injection.html).</span><span class="sxs-lookup"><span data-stu-id="22344-128">Martin Fowler has written an extensive article on [Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html).</span></span> <span data-ttu-id="22344-129">Microsoft Patterns and Practices ha anche una descrizione di grande [Dependency Injection](https://msdn.microsoft.com/library/hh323705.aspx).</span><span class="sxs-lookup"><span data-stu-id="22344-129">Microsoft Patterns and Practices also has a great description of [Dependency Injection](https://msdn.microsoft.com/library/hh323705.aspx).</span></span>

> [!NOTE]
> <span data-ttu-id="22344-130">Questo articolo descrive l'inserimento di dipendenze applicata a tutte le applicazioni ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="22344-130">This article covers Dependency Injection as it applies to all ASP.NET applications.</span></span> <span data-ttu-id="22344-131">Inserimento di dipendenze all'interno di controller MVC è trattata nella [inserimento di dipendenze e i controller](../mvc/controllers/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="22344-131">Dependency Injection within MVC controllers is covered in [Dependency Injection and Controllers](../mvc/controllers/dependency-injection.md).</span></span>

### <a name="constructor-injection-behavior"></a><span data-ttu-id="22344-132">Comportamento di attacco intrusivo nel codice del costruttore</span><span class="sxs-lookup"><span data-stu-id="22344-132">Constructor Injection Behavior</span></span>

<span data-ttu-id="22344-133">Inserimento del costruttore richiede che il costruttore in questione sia *pubblica*.</span><span class="sxs-lookup"><span data-stu-id="22344-133">Constructor injection requires that the constructor in question be *public*.</span></span> <span data-ttu-id="22344-134">In caso contrario, l'applicazione genera un `InvalidOperationException`:</span><span class="sxs-lookup"><span data-stu-id="22344-134">Otherwise, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="22344-135">Non è possibile trova un costruttore adeguato per il tipo 'YourType'.</span><span class="sxs-lookup"><span data-stu-id="22344-135">A suitable constructor for type 'YourType' could not be located.</span></span> <span data-ttu-id="22344-136">Verificare il tipo è concreto e i servizi vengono registrati per tutti i parametri di un costruttore pubblico.</span><span class="sxs-lookup"><span data-stu-id="22344-136">Ensure the type is concrete and services are registered for all parameters of a public constructor.</span></span>


<span data-ttu-id="22344-137">Inserimento del costruttore necessario sia presente un solo costruttore applicabile.</span><span class="sxs-lookup"><span data-stu-id="22344-137">Constructor injection requires that only one applicable constructor exist.</span></span> <span data-ttu-id="22344-138">Sono supportati gli overload del costruttore, ma solo uno degli overload possono essere presenti tutti i cui argomenti possono essere soddisfatti dall'inserimento di dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-138">Constructor overloads are supported, but only one overload can exist whose arguments can all be fulfilled by dependency injection.</span></span> <span data-ttu-id="22344-139">Se esiste più di uno, l'applicazione genererà un `InvalidOperationException`:</span><span class="sxs-lookup"><span data-stu-id="22344-139">If more than one exists, your app will throw an `InvalidOperationException`:</span></span>

> <span data-ttu-id="22344-140">Trovata più di un costruttore che accetta tutti i tipi di argomento specificato nel tipo 'YourType'.</span><span class="sxs-lookup"><span data-stu-id="22344-140">Multiple constructors accepting all given argument types have been found in type 'YourType'.</span></span> <span data-ttu-id="22344-141">Deve essere presente solo un costruttore applicabile.</span><span class="sxs-lookup"><span data-stu-id="22344-141">There should only be one applicable constructor.</span></span>

<span data-ttu-id="22344-142">I costruttori possono accettare argomenti non disponibili per l'inserimento di dipendenze, ma questi devono supportare i valori predefiniti.</span><span class="sxs-lookup"><span data-stu-id="22344-142">Constructors can accept arguments that are not provided by dependency injection, but these must support default values.</span></span> <span data-ttu-id="22344-143">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="22344-143">For example:</span></span>

```csharp
// throws InvalidOperationException: Unable to resolve service for type 'System.String'...
public CharactersController(ICharacterRepository characterRepository, string title)
{
    _characterRepository = characterRepository;
    _title = title;
}

// runs without error
public CharactersController(ICharacterRepository characterRepository, string title = "Characters")
{
    _characterRepository = characterRepository;
    _title = title;
}
```

## <a name="using-framework-provided-services"></a><span data-ttu-id="22344-144">Utilizzo dei servizi forniti dal Framework</span><span class="sxs-lookup"><span data-stu-id="22344-144">Using Framework-Provided Services</span></span>

<span data-ttu-id="22344-145">Il `ConfigureServices` metodo la `Startup` classe è responsabile per definire i servizi verranno usate dall'applicazione, incluse funzionalità di piattaforma come Entity Framework Core e ASP.NET MVC di base.</span><span class="sxs-lookup"><span data-stu-id="22344-145">The `ConfigureServices` method in the `Startup` class is responsible for defining the services the application will use, including platform features like Entity Framework Core and ASP.NET Core MVC.</span></span> <span data-ttu-id="22344-146">Inizialmente, il `IServiceCollection` fornito per `ConfigureServices` ha i seguenti servizi definiti (in base alle [come è stato configurato l'host](xref:fundamentals/hosting)):</span><span class="sxs-lookup"><span data-stu-id="22344-146">Initially, the `IServiceCollection` provided to `ConfigureServices` has the following services defined (depending on [how the host was configured](xref:fundamentals/hosting)):</span></span>

| <span data-ttu-id="22344-147">Tipo di servizio</span><span class="sxs-lookup"><span data-stu-id="22344-147">Service Type</span></span> | <span data-ttu-id="22344-148">Durata</span><span class="sxs-lookup"><span data-stu-id="22344-148">Lifetime</span></span> |
| ----- | ------- |
| [<span data-ttu-id="22344-149">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span><span class="sxs-lookup"><span data-stu-id="22344-149">Microsoft.AspNetCore.Hosting.IHostingEnvironment</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.ihostingenvironment) | <span data-ttu-id="22344-150">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-150">Singleton</span></span> |
| [<span data-ttu-id="22344-151">Microsoft.Extensions.Logging.ILoggerFactory</span><span class="sxs-lookup"><span data-stu-id="22344-151">Microsoft.Extensions.Logging.ILoggerFactory</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.logging.iloggerfactory) | <span data-ttu-id="22344-152">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-152">Singleton</span></span> |
| [<span data-ttu-id="22344-153">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="22344-153">Microsoft.Extensions.Logging.ILogger&lt;T&gt;</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.logging.ilogger) | <span data-ttu-id="22344-154">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-154">Singleton</span></span> |
| [<span data-ttu-id="22344-155">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span><span class="sxs-lookup"><span data-stu-id="22344-155">Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.builder.iapplicationbuilderfactory) | <span data-ttu-id="22344-156">Temporaneo</span><span class="sxs-lookup"><span data-stu-id="22344-156">Transient</span></span> |
| [<span data-ttu-id="22344-157">Microsoft.AspNetCore.Http.IHttpContextFactory</span><span class="sxs-lookup"><span data-stu-id="22344-157">Microsoft.AspNetCore.Http.IHttpContextFactory</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.http.ihttpcontextfactory) | <span data-ttu-id="22344-158">Temporaneo</span><span class="sxs-lookup"><span data-stu-id="22344-158">Transient</span></span> |
| [<span data-ttu-id="22344-159">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="22344-159">Microsoft.Extensions.Options.IOptions&lt;T&gt;</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.options.ioptions-1) | <span data-ttu-id="22344-160">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-160">Singleton</span></span> |
| [<span data-ttu-id="22344-161">System.Diagnostics.DiagnosticSource</span><span class="sxs-lookup"><span data-stu-id="22344-161">System.Diagnostics.DiagnosticSource</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticsource) | <span data-ttu-id="22344-162">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-162">Singleton</span></span> |
| [<span data-ttu-id="22344-163">System.Diagnostics.DiagnosticListener</span><span class="sxs-lookup"><span data-stu-id="22344-163">System.Diagnostics.DiagnosticListener</span></span>](https://docs.microsoft.com/dotnet/core/api/system.diagnostics.diagnosticlistener) | <span data-ttu-id="22344-164">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-164">Singleton</span></span> |
| [<span data-ttu-id="22344-165">Microsoft.AspNetCore.Hosting.IStartupFilter</span><span class="sxs-lookup"><span data-stu-id="22344-165">Microsoft.AspNetCore.Hosting.IStartupFilter</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.istartupfilter) | <span data-ttu-id="22344-166">Temporaneo</span><span class="sxs-lookup"><span data-stu-id="22344-166">Transient</span></span> |
| [<span data-ttu-id="22344-167">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span><span class="sxs-lookup"><span data-stu-id="22344-167">Microsoft.Extensions.ObjectPool.ObjectPoolProvider</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.objectpool.objectpoolprovider) | <span data-ttu-id="22344-168">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-168">Singleton</span></span> |
| [<span data-ttu-id="22344-169">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span><span class="sxs-lookup"><span data-stu-id="22344-169">Microsoft.Extensions.Options.IConfigureOptions&lt;T&gt;</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.extensions.options.iconfigureoptions-1) | <span data-ttu-id="22344-170">Temporaneo</span><span class="sxs-lookup"><span data-stu-id="22344-170">Transient</span></span> |
| [<span data-ttu-id="22344-171">Microsoft.AspNetCore.Hosting.Server.IServer</span><span class="sxs-lookup"><span data-stu-id="22344-171">Microsoft.AspNetCore.Hosting.Server.IServer</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.server.iserver) | <span data-ttu-id="22344-172">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-172">Singleton</span></span> |
| [<span data-ttu-id="22344-173">Microsoft.AspNetCore.Hosting.IStartup</span><span class="sxs-lookup"><span data-stu-id="22344-173">Microsoft.AspNetCore.Hosting.IStartup</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.istartup) | <span data-ttu-id="22344-174">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-174">Singleton</span></span> |
| [<span data-ttu-id="22344-175">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span><span class="sxs-lookup"><span data-stu-id="22344-175">Microsoft.AspNetCore.Hosting.IApplicationLifetime</span></span>](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.hosting.iapplicationlifetime) | <span data-ttu-id="22344-176">Singleton</span><span class="sxs-lookup"><span data-stu-id="22344-176">Singleton</span></span> |

<span data-ttu-id="22344-177">Di seguito è riportato un esempio di come aggiungere servizi aggiuntivi per il contenitore utilizzando un numero di metodi di estensione, ad esempio `AddDbContext`, `AddIdentity`, e `AddMvc`.</span><span class="sxs-lookup"><span data-stu-id="22344-177">Below is an example of how to add additional services to the container using a number of extension methods like `AddDbContext`, `AddIdentity`, and `AddMvc`.</span></span>

[!code-csharp[Main](../common/samples/WebApplication1/Startup.cs?highlight=5-6,8-10,12&range=39-56)]

<span data-ttu-id="22344-178">Le funzionalità fornite da ASP.NET, ad esempio MVC, middleware seguono una convenzione dell'utilizzo di un singolo componente*ServiceName* metodo di estensione per registrare tutti i servizi richiesti da tale funzionalità.</span><span class="sxs-lookup"><span data-stu-id="22344-178">The features and middleware provided by ASP.NET, such as MVC, follow a convention of using a single Add*ServiceName* extension method to register all of the services required by that feature.</span></span>

>[!TIP]
> <span data-ttu-id="22344-179">È possibile richiedere determinati servizi forniti dal framework all'interno di `Startup` metodi tramite i relativi elenchi di parametri, vedere [avvio dell'applicazione](startup.md) per altri dettagli.</span><span class="sxs-lookup"><span data-stu-id="22344-179">You can request certain framework-provided services within `Startup` methods through their parameter lists - see [Application Startup](startup.md) for more details.</span></span>

## <a name="registering-your-own-services"></a><span data-ttu-id="22344-180">Registrazione di servizi personalizzati</span><span class="sxs-lookup"><span data-stu-id="22344-180">Registering Your Own Services</span></span>

<span data-ttu-id="22344-181">È possibile registrare i servizi dell'applicazione, come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="22344-181">You can register your own application services as follows.</span></span> <span data-ttu-id="22344-182">Il primo tipo generico rappresenta il tipo (in genere un'interfaccia) che verrà richieste dal contenitore.</span><span class="sxs-lookup"><span data-stu-id="22344-182">The first generic type represents the type (typically an interface) that will be requested from the container.</span></span> <span data-ttu-id="22344-183">Il secondo tipo generico rappresenta il tipo concreto che verrà creata un'istanza mediante il contenitore e utilizzato per soddisfare tali richieste.</span><span class="sxs-lookup"><span data-stu-id="22344-183">The second generic type represents the concrete type that will be instantiated by the container and used to fulfill such requests.</span></span>

[!code-csharp[Main](../common/samples/WebApplication1/Startup.cs?range=53-54)]

> [!NOTE]
> <span data-ttu-id="22344-184">Ogni `services.Add<ServiceName>` metodo di estensione aggiunge (e potenzialmente Configura) servizi.</span><span class="sxs-lookup"><span data-stu-id="22344-184">Each `services.Add<ServiceName>` extension method adds (and potentially configures) services.</span></span> <span data-ttu-id="22344-185">Ad esempio, `services.AddMvc()` aggiunge i servizi MVC richiede.</span><span class="sxs-lookup"><span data-stu-id="22344-185">For example, `services.AddMvc()` adds the services MVC requires.</span></span> <span data-ttu-id="22344-186">È consigliabile attenersi a questa convenzione, inserire i metodi di estensione nel `Microsoft.Extensions.DependencyInjection` dello spazio dei nomi per incapsulare i gruppi di registrazioni di servizio.</span><span class="sxs-lookup"><span data-stu-id="22344-186">It's recommended that you follow this convention, placing extension methods in the `Microsoft.Extensions.DependencyInjection` namespace, to encapsulate groups of service registrations.</span></span>

<span data-ttu-id="22344-187">Il `AddTransient` metodo viene utilizzato per eseguire il mapping di tipi astratti ai servizi concreti istanze vengono creati separatamente per ogni oggetto che lo richiede.</span><span class="sxs-lookup"><span data-stu-id="22344-187">The `AddTransient` method is used to map abstract types to concrete services that are instantiated separately for every object that requires it.</span></span> <span data-ttu-id="22344-188">Questo è noto come il servizio *durata*, e le opzioni di durata aggiuntive descritte di seguito.</span><span class="sxs-lookup"><span data-stu-id="22344-188">This is known as the service's *lifetime*, and additional lifetime options are described below.</span></span> <span data-ttu-id="22344-189">È importante scegliere una durata appropriata per ognuno dei servizi di che registrazione.</span><span class="sxs-lookup"><span data-stu-id="22344-189">It is important to choose an appropriate lifetime for each of the services you register.</span></span> <span data-ttu-id="22344-190">Una nuova istanza del servizio deve essere fornita a ogni classe che lo richiede.</span><span class="sxs-lookup"><span data-stu-id="22344-190">Should a new instance of the service be provided to each class that requests it?</span></span> <span data-ttu-id="22344-191">Un'istanza da utilizzare in una richiesta web specificato.</span><span class="sxs-lookup"><span data-stu-id="22344-191">Should one instance be used throughout a given web request?</span></span> <span data-ttu-id="22344-192">O una singola istanza deve essere utilizzata per la durata dell'applicazione?</span><span class="sxs-lookup"><span data-stu-id="22344-192">Or should a single instance be used for the lifetime of the application?</span></span>

<span data-ttu-id="22344-193">Nell'esempio di questo articolo, è un controller semplice che visualizza i nomi di caratteri, chiamati `CharactersController`.</span><span class="sxs-lookup"><span data-stu-id="22344-193">In the sample for this article, there is a simple controller that displays character names, called `CharactersController`.</span></span> <span data-ttu-id="22344-194">Il relativo `Index` metodo consente di visualizzare l'elenco corrente di caratteri che sono stati archiviati nell'applicazione e inizializza la raccolta con un numero limitato di caratteri se non esiste.</span><span class="sxs-lookup"><span data-stu-id="22344-194">Its `Index` method displays the current list of characters that have been stored in the application, and initializes the collection with a handful of characters if none exist.</span></span> <span data-ttu-id="22344-195">Si noti che anche se questa applicazione usa Entity Framework Core e `ApplicationDbContext` classe per la persistenza, nessuno di questi obiettivi è evidente nel controller.</span><span class="sxs-lookup"><span data-stu-id="22344-195">Note that although this application uses Entity Framework Core and the `ApplicationDbContext` class for its persistence, none of that is apparent in the controller.</span></span> <span data-ttu-id="22344-196">Al contrario, il meccanismo di accesso ai dati specifici è stato indipendenti e possono essere protetti da un'interfaccia, `ICharacterRepository`, che segue il [modello di repository](http://deviq.com/repository-pattern/).</span><span class="sxs-lookup"><span data-stu-id="22344-196">Instead, the specific data access mechanism has been abstracted behind an interface, `ICharacterRepository`, which follows the [repository pattern](http://deviq.com/repository-pattern/).</span></span> <span data-ttu-id="22344-197">Un'istanza di `ICharacterRepository` viene richiesto tramite il costruttore e assegnato a un campo privato, che viene quindi usato per accedere ai caratteri in base alle esigenze.</span><span class="sxs-lookup"><span data-stu-id="22344-197">An instance of `ICharacterRepository` is requested via the constructor and assigned to a private field, which is then used to access characters as necessary.</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Controllers/CharactersController.cs?highlight=3,5,6,7,8,14,21-27&range=8-36)]

<span data-ttu-id="22344-198">Il `ICharacterRepository` definisce i metodi di due controller deve essere utilizzato con `Character` istanze.</span><span class="sxs-lookup"><span data-stu-id="22344-198">The `ICharacterRepository` defines the two methods the controller needs to work with `Character` instances.</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/ICharacterRepository.cs?highlight=8,9)]

<span data-ttu-id="22344-199">Questa interfaccia viene implementata a sua volta da un tipo concreto, `CharacterRepository`, che viene utilizzato in fase di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="22344-199">This interface is in turn implemented by a concrete type, `CharacterRepository`, that is used at runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="22344-200">Viene utilizzata la modalità DI con la `CharacterRepository` classe è un modello generale, è possibile seguire per tutti i servizi dell'applicazione, non solo in "repository" o classi di accesso ai dati.</span><span class="sxs-lookup"><span data-stu-id="22344-200">The way DI is used with the `CharacterRepository` class is a general model you can follow for all of your application services, not just in "repositories" or data access classes.</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Models/CharacterRepository.cs?highlight=9,11,12,13,14)]

<span data-ttu-id="22344-201">Si noti che `CharacterRepository` richieste un `ApplicationDbContext` nel relativo costruttore.</span><span class="sxs-lookup"><span data-stu-id="22344-201">Note that `CharacterRepository` requests an `ApplicationDbContext` in its constructor.</span></span> <span data-ttu-id="22344-202">Non è insolito per l'inserimento di dipendenze da utilizzare in modo concatenato simile al seguente, con ogni dipendenza richiesta richiede a sua volta relative dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-202">It is not unusual for dependency injection to be used in a chained fashion like this, with each requested dependency in turn requesting its own dependencies.</span></span> <span data-ttu-id="22344-203">Il contenitore è responsabile per la risoluzione di tutte le dipendenze nel grafico e la restituzione viene completamente risolto.</span><span class="sxs-lookup"><span data-stu-id="22344-203">The container is responsible for resolving all of the dependencies in the graph and returning the fully resolved service.</span></span>

> [!NOTE]
> <span data-ttu-id="22344-204">Creare l'oggetto richiesto e tutti gli oggetti richiede e tutti gli oggetti di tali criteri richiedono, è talvolta detta un *oggetto grafico*.</span><span class="sxs-lookup"><span data-stu-id="22344-204">Creating the requested object, and all of the objects it requires, and all of the objects those require, is sometimes referred to as an *object graph*.</span></span> <span data-ttu-id="22344-205">Analogamente, il set di dipendenze che devono essere risolti collettivo viene generalmente indicato come un *albero delle dipendenze* o *grafico dipendenze*.</span><span class="sxs-lookup"><span data-stu-id="22344-205">Likewise, the collective set of dependencies that must be resolved is typically referred to as a *dependency tree* or *dependency graph*.</span></span>

<span data-ttu-id="22344-206">In questo caso, entrambi `ICharacterRepository` e a sua volta `ApplicationDbContext` deve essere registrato con il contenitore dei servizi in `ConfigureServices` in `Startup`.</span><span class="sxs-lookup"><span data-stu-id="22344-206">In this case, both `ICharacterRepository` and in turn `ApplicationDbContext` must be registered with the services container in `ConfigureServices` in `Startup`.</span></span> <span data-ttu-id="22344-207">`ApplicationDbContext`è configurato con la chiamata al metodo di estensione `AddDbContext<T>`.</span><span class="sxs-lookup"><span data-stu-id="22344-207">`ApplicationDbContext` is configured with the call to the extension method `AddDbContext<T>`.</span></span> <span data-ttu-id="22344-208">Il codice seguente illustra la registrazione del `CharacterRepository` tipo.</span><span class="sxs-lookup"><span data-stu-id="22344-208">The following code shows the registration of the `CharacterRepository` type.</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Startup.cs?highlight=3-5,11&range=16-32)]

<span data-ttu-id="22344-209">Contesti di Entity Framework devono essere aggiunti al contenitore di servizi usando il `Scoped` durata.</span><span class="sxs-lookup"><span data-stu-id="22344-209">Entity Framework contexts should be added to the services container using the `Scoped` lifetime.</span></span> <span data-ttu-id="22344-210">Ciò viene preso in considerazione automaticamente se si utilizzano i metodi di supporto, come illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="22344-210">This is taken care of automatically if you use the helper methods as shown above.</span></span> <span data-ttu-id="22344-211">I repository che utilizza Entity Framework devono utilizzare la stessa durata.</span><span class="sxs-lookup"><span data-stu-id="22344-211">Repositories that will make use of Entity Framework should use the same lifetime.</span></span>

>[!WARNING]
> <span data-ttu-id="22344-212">Risolve il pericolo principale per assicurarsi di aver un `Scoped` servizio da un singleton.</span><span class="sxs-lookup"><span data-stu-id="22344-212">The main danger to be wary of is resolving a `Scoped` service from a singleton.</span></span> <span data-ttu-id="22344-213">È probabile che in questo caso che il servizio sarà di stato non corretto durante l'elaborazione delle richieste successive.</span><span class="sxs-lookup"><span data-stu-id="22344-213">It's likely in such a case that the service will have incorrect state when processing subsequent requests.</span></span>

<span data-ttu-id="22344-214">Servizi che hanno dipendenze devono registrarli nel contenitore.</span><span class="sxs-lookup"><span data-stu-id="22344-214">Services that have dependencies should register them in the container.</span></span> <span data-ttu-id="22344-215">Se il costruttore di un servizio richiede una primitiva, ad esempio un `string`, si possono essere inserita utilizzando [configurazione](xref:fundamentals/configuration/index) e [modello opzioni](xref:fundamentals/configuration/options).</span><span class="sxs-lookup"><span data-stu-id="22344-215">If a service's constructor requires a primitive, such as a `string`, this can be injected by using [configuration](xref:fundamentals/configuration/index) and the [options pattern](xref:fundamentals/configuration/options).</span></span>

## <a name="service-lifetimes-and-registration-options"></a><span data-ttu-id="22344-216">La durata del servizio e le opzioni di registrazione</span><span class="sxs-lookup"><span data-stu-id="22344-216">Service Lifetimes and Registration Options</span></span>

<span data-ttu-id="22344-217">Servizi ASP.NET possono essere configurati con le durate seguenti:</span><span class="sxs-lookup"><span data-stu-id="22344-217">ASP.NET services can be configured with the following lifetimes:</span></span>

<span data-ttu-id="22344-218">**Temporaneo**</span><span class="sxs-lookup"><span data-stu-id="22344-218">**Transient**</span></span>

<span data-ttu-id="22344-219">Servizi di durata temporanei vengono creati ogni volta che vengono richiesti.</span><span class="sxs-lookup"><span data-stu-id="22344-219">Transient lifetime services are created each time they are requested.</span></span> <span data-ttu-id="22344-220">Questa durata è consigliata per i servizi senza stati leggeri.</span><span class="sxs-lookup"><span data-stu-id="22344-220">This lifetime works best for lightweight, stateless services.</span></span>

<span data-ttu-id="22344-221">**Ambito**</span><span class="sxs-lookup"><span data-stu-id="22344-221">**Scoped**</span></span>

<span data-ttu-id="22344-222">Servizi di durata con ambito vengono creati una volta per ogni richiesta.</span><span class="sxs-lookup"><span data-stu-id="22344-222">Scoped lifetime services are created once per request.</span></span>

<span data-ttu-id="22344-223">**Singleton**</span><span class="sxs-lookup"><span data-stu-id="22344-223">**Singleton**</span></span>

<span data-ttu-id="22344-224">Servizi di durata singleton vengono creati la prima volta in cui vengono richiesti (o quando `ConfigureServices` viene eseguito se si specifica un'istanza non esiste), quindi tutte le richieste successive utilizzerà la stessa istanza.</span><span class="sxs-lookup"><span data-stu-id="22344-224">Singleton lifetime services are created the first time they are requested (or when `ConfigureServices` is run if you specify an instance there) and then every subsequent request will use the same instance.</span></span> <span data-ttu-id="22344-225">Se l'applicazione richiede un comportamento singleton, è consigliabile consentire il contenitore dei servizi gestire la durata del servizio anziché implementare il modello di progettazione singleton e gestire la durata dell'oggetto nella classe in prima persona.</span><span class="sxs-lookup"><span data-stu-id="22344-225">If your application requires singleton behavior, allowing the services container to manage the service's lifetime is recommended instead of implementing the singleton design pattern and managing your object's lifetime in the class yourself.</span></span>

<span data-ttu-id="22344-226">I servizi possono essere registrati con il contenitore in diversi modi.</span><span class="sxs-lookup"><span data-stu-id="22344-226">Services can be registered with the container in several ways.</span></span> <span data-ttu-id="22344-227">Abbiamo già visto come registrare un'implementazione del servizio con un determinato tipo, specificando il tipo concreto da usare.</span><span class="sxs-lookup"><span data-stu-id="22344-227">We have already seen how to register a service implementation with a given type by specifying the concrete type to use.</span></span> <span data-ttu-id="22344-228">Inoltre, una factory può essere specificato, che verrà quindi utilizzato per creare l'istanza su richiesta.</span><span class="sxs-lookup"><span data-stu-id="22344-228">In addition, a factory can be specified, which will then be used to create the instance on demand.</span></span> <span data-ttu-id="22344-229">Il terzo approccio consiste nello specificare direttamente l'istanza del tipo da utilizzare, in cui caso il contenitore non tenterà di creare un'istanza (né verrà dispose dell'istanza).</span><span class="sxs-lookup"><span data-stu-id="22344-229">The third approach is to directly specify the instance of the type to use, in which case the container will never attempt to create an instance (nor will it dispose of the instance).</span></span>

<span data-ttu-id="22344-230">Per illustrare la differenza tra le opzioni di durata e la registrazione, si consideri una semplice interfaccia che rappresenta una o più attività come un *operazione* con un identificatore univoco, `OperationId`.</span><span class="sxs-lookup"><span data-stu-id="22344-230">To demonstrate the difference between these lifetime and registration options, consider a simple interface that represents one or more tasks as an *operation* with a unique identifier, `OperationId`.</span></span> <span data-ttu-id="22344-231">A seconda di come si configura la durata per questo servizio, il contenitore fornirà uguali o diverse istanze del servizio per la classe richiesta.</span><span class="sxs-lookup"><span data-stu-id="22344-231">Depending on how we configure the lifetime for this service, the container will provide either the same or different instances of the service to the requesting class.</span></span> <span data-ttu-id="22344-232">Per indicare chiaramente quali durata viene richiesto, si creerà un tipo per ogni opzione di durata:</span><span class="sxs-lookup"><span data-stu-id="22344-232">To make it clear which lifetime is being requested, we will create one type per lifetime option:</span></span>

[!code-csharp[Main](../fundamentals/dependency-injection/sample/DependencyInjectionSample/Interfaces/IOperation.cs?highlight=5-8)]

<span data-ttu-id="22344-233">Implementare queste interfacce utilizzando un'unica classe `Operation`, che accetta un `Guid` nel relativo costruttore o utilizza un nuovo `Guid` se non è specificato.</span><span class="sxs-lookup"><span data-stu-id="22344-233">We implement these interfaces using a single class, `Operation`, that accepts a `Guid` in its constructor, or uses a new `Guid` if none is provided.</span></span>

<span data-ttu-id="22344-234">Successivamente, nel `ConfigureServices`, ogni tipo viene aggiunto al contenitore in base alla durata denominata:</span><span class="sxs-lookup"><span data-stu-id="22344-234">Next, in `ConfigureServices`, each type is added to the container according to its named lifetime:</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Startup.cs?range=26-32)]

<span data-ttu-id="22344-235">Si noti che il `IOperationSingletonInstance` servizio utilizza un'istanza specifica con un ID noto di `Guid.Empty` in modo che sia chiaro quando questo tipo è in uso (il relativo Guid sarà tutti zeri).</span><span class="sxs-lookup"><span data-stu-id="22344-235">Note that the `IOperationSingletonInstance` service is using a specific instance with a known ID of `Guid.Empty` so it will be clear when this type is in use (its Guid will be all zeroes).</span></span> <span data-ttu-id="22344-236">È stato registrato anche un `OperationService` che dipende da ognuno degli altri `Operation` tipi, in modo che sia possibile deselezionare all'interno di una richiesta se questo servizio è di ottenere la stessa istanza del controller o un altro, per ogni tipo di operazione.</span><span class="sxs-lookup"><span data-stu-id="22344-236">We have also registered an `OperationService` that depends on each of the other `Operation` types, so that it will be clear within a request whether this service is getting the same instance as the controller, or a new one, for each operation type.</span></span> <span data-ttu-id="22344-237">Questo servizio non è di esporre le relative dipendenze come proprietà, in modo che possano essere visualizzate nella vista.</span><span class="sxs-lookup"><span data-stu-id="22344-237">All this service does is expose its dependencies as properties, so they can be displayed in the view.</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Services/OperationService.cs)]

<span data-ttu-id="22344-238">Per dimostrare la durata degli oggetti all'interno e tra separate singole richieste all'applicazione, l'esempio include un `OperationsController` che richiede ogni tipo di `IOperation` tipo, nonché un `OperationService`.</span><span class="sxs-lookup"><span data-stu-id="22344-238">To demonstrate the object lifetimes within and between separate individual requests to the application, the sample includes an `OperationsController` that requests each kind of `IOperation` type as well as an `OperationService`.</span></span> <span data-ttu-id="22344-239">Il `Index` quindi l'azione consente di visualizzare tutti i controller e del servizio `OperationId` valori.</span><span class="sxs-lookup"><span data-stu-id="22344-239">The `Index` action then displays all of the controller's and service's `OperationId` values.</span></span>

[!code-csharp[Main](dependency-injection/sample/DependencyInjectionSample/Controllers/OperationsController.cs)]

<span data-ttu-id="22344-240">Ora due richieste separate vengono apportate a questa azione del controller:</span><span class="sxs-lookup"><span data-stu-id="22344-240">Now two separate requests are made to this controller action:</span></span>

![Visualizzazione delle operazioni dell'applicazione web di esempio di inserimento di dipendenza in esecuzione in Microsoft Edge con i valori di ID operazione (GUID) per temporaneo, nell'ambito, Singleton e il Controller di istanza e operazioni del servizio operazione alla prima richiesta.](dependency-injection/_static/lifetimes_request1.png)

![Le operazioni di visualizzazione che mostra i valori di ID operazione per una seconda richiesta.](dependency-injection/_static/lifetimes_request2.png)

<span data-ttu-id="22344-243">Osservare quali il `OperationId` valori variare all'interno di una richiesta e tra le richieste.</span><span class="sxs-lookup"><span data-stu-id="22344-243">Observe which of the `OperationId` values vary within a request, and between requests.</span></span>

* <span data-ttu-id="22344-244">*Temporaneo* sempre gli oggetti sono diversi; viene fornita una nuova istanza per tutti i controller e a ogni servizio.</span><span class="sxs-lookup"><span data-stu-id="22344-244">*Transient* objects are always different; a new instance is provided to every controller and every service.</span></span>

* <span data-ttu-id="22344-245">*Ambito* oggetti sono uguali all'interno di una richiesta, ma è diversa nelle diverse richieste</span><span class="sxs-lookup"><span data-stu-id="22344-245">*Scoped* objects are the same within a request, but different across different requests</span></span>

* <span data-ttu-id="22344-246">*Singleton* oggetti sono uguali per tutti gli oggetti e ogni richiesta (indipendentemente dal fatto che un'istanza viene fornita `ConfigureServices`)</span><span class="sxs-lookup"><span data-stu-id="22344-246">*Singleton* objects are the same for every object and every request (regardless of whether an instance is provided in `ConfigureServices`)</span></span>

## <a name="request-services"></a><span data-ttu-id="22344-247">Servizi di richiesta</span><span class="sxs-lookup"><span data-stu-id="22344-247">Request Services</span></span>

<span data-ttu-id="22344-248">Richiedere i servizi disponibili all'interno di un ASP.NET `HttpContext` vengono esposti tramite il `RequestServices` insieme.</span><span class="sxs-lookup"><span data-stu-id="22344-248">The services available within an ASP.NET request from `HttpContext` are exposed through the `RequestServices` collection.</span></span>

![HttpContext richiesta servizi Intellisense contesto finestra di dialogo che informa che servizi di richiesta Ottiene o imposta l'IServiceProvider che fornisce l'accesso al contenitore dei servizi della richiesta.](dependency-injection/_static/request-services.png)

<span data-ttu-id="22344-250">Servizi di richiesta rappresentano i servizi si configurano e richiesta come parte dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="22344-250">Request Services represent the services you configure and request as part of your application.</span></span> <span data-ttu-id="22344-251">Quando gli oggetti di specificano le dipendenze, queste sono soddisfatti dai tipi individuati nella `RequestServices`, non `ApplicationServices`.</span><span class="sxs-lookup"><span data-stu-id="22344-251">When your objects specify dependencies, these are satisfied by the types found in `RequestServices`, not `ApplicationServices`.</span></span>

<span data-ttu-id="22344-252">In genere, è consigliabile utilizzare queste proprietà direttamente, preferendo invece richiedere i tipi di classi che è necessario tramite il costruttore della classe e lasciare che il framework di inserire queste dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-252">Generally, you shouldn't use these properties directly, preferring instead to request the types your classes you require via your class's constructor, and letting the framework inject these dependencies.</span></span> <span data-ttu-id="22344-253">Si ottengono le classi che sono più facili da testare (vedere [Testing](../testing/index.md)) e non siano più strettamente collegati.</span><span class="sxs-lookup"><span data-stu-id="22344-253">This yields classes that are easier to test (see [Testing](../testing/index.md)) and are more loosely coupled.</span></span>

> [!NOTE]
> <span data-ttu-id="22344-254">Preferisce richiedere dipendenze come parametri del costruttore per l'accesso di `RequestServices` insieme.</span><span class="sxs-lookup"><span data-stu-id="22344-254">Prefer requesting dependencies as constructor parameters to accessing the `RequestServices` collection.</span></span>

## <a name="designing-your-services-for-dependency-injection"></a><span data-ttu-id="22344-255">Progettazione di servizi per l'inserimento di dipendenze</span><span class="sxs-lookup"><span data-stu-id="22344-255">Designing Your Services For Dependency Injection</span></span>

<span data-ttu-id="22344-256">È consigliabile progettare i servizi di utilizzare l'inserimento di dipendenze per ottenere i collaboratori.</span><span class="sxs-lookup"><span data-stu-id="22344-256">You should design your services to use dependency injection to get their collaborators.</span></span> <span data-ttu-id="22344-257">Ciò significa evitare l'uso di chiamate al metodo statico con stato (che portare a un odore codice noto come [adesive statico](http://deviq.com/static-cling/)) e la creazione di istanze diretto delle classi dipendenti all'interno dei servizi.</span><span class="sxs-lookup"><span data-stu-id="22344-257">This means avoiding the use of stateful static method calls (which result in a code smell known as [static cling](http://deviq.com/static-cling/)) and the direct instantiation of dependent classes within your services.</span></span> <span data-ttu-id="22344-258">Può essere utile per ricordare la frase [nuovi è Glue](https://ardalis.com/new-is-glue), quando si sceglie di creare un'istanza di un tipo o di richiederla tramite l'inserimento di dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-258">It may help to remember the phrase, [New is Glue](https://ardalis.com/new-is-glue), when choosing whether to instantiate a type or to request it via dependency injection.</span></span> <span data-ttu-id="22344-259">Seguendo il [a tinta unita principi dell'oggetto orientato alla progettazione](http://deviq.com/solid/), le classi tendono a essere piccole, facilmente testato e corretto factoring.</span><span class="sxs-lookup"><span data-stu-id="22344-259">By following the [SOLID Principles of Object Oriented Design](http://deviq.com/solid/), your classes will naturally tend to be small, well-factored, and easily tested.</span></span>

<span data-ttu-id="22344-260">Cosa accade se si trova che le classi tendono ad avere modo troppe dipendenze venga introdotto?</span><span class="sxs-lookup"><span data-stu-id="22344-260">What if you find that your classes tend to have way too many dependencies being injected?</span></span> <span data-ttu-id="22344-261">In genere si tratta di un segno che la classe sta tentando di eccessivo e se è probabile che stanno violando i criteri di restrizione software - il [singolo responsabilità principio](http://deviq.com/single-responsibility-principle/).</span><span class="sxs-lookup"><span data-stu-id="22344-261">This is generally a sign that your class is trying to do too much, and is probably violating SRP - the [Single Responsibility Principle](http://deviq.com/single-responsibility-principle/).</span></span> <span data-ttu-id="22344-262">Vedere se è possibile effettuare il refactoring della classe da spostare alcune delle proprie funzioni in una nuova classe.</span><span class="sxs-lookup"><span data-stu-id="22344-262">See if you can refactor the class by moving some of its responsibilities into a new class.</span></span> <span data-ttu-id="22344-263">Tenere presente che il `Controller` classi devono essere incentrate sulle problematiche dell'interfaccia utente, in modo business dati e le regole di accesso ai dettagli di implementazione devono essere conservati in classi appropriate a questi [separare le problematiche](http://deviq.com/separation-of-concerns/).</span><span class="sxs-lookup"><span data-stu-id="22344-263">Keep in mind that your `Controller` classes should be focused on UI concerns, so business rules and data access implementation details should be kept in classes appropriate to these [separate concerns](http://deviq.com/separation-of-concerns/).</span></span>

<span data-ttu-id="22344-264">Per quanto riguarda l'accesso ai dati in particolare, è possibile inserire il `DbContext` il controller (presupponendo che EF aggiunti al contenitore di servizi `ConfigureServices`).</span><span class="sxs-lookup"><span data-stu-id="22344-264">With regards to data access specifically, you can inject the `DbContext` into your controllers (assuming you've added EF to the services container in `ConfigureServices`).</span></span> <span data-ttu-id="22344-265">Alcuni sviluppatori preferiscono utilizzare un'interfaccia del repository per il database anziché inserendo il `DbContext` direttamente.</span><span class="sxs-lookup"><span data-stu-id="22344-265">Some developers prefer to use a repository interface to the database rather than injecting the `DbContext` directly.</span></span> <span data-ttu-id="22344-266">Utilizzando un'interfaccia per incapsulare i dati della logica di accesso in un'unica posizione può ridurre il numero di posizioni è necessario modificare il database cambia.</span><span class="sxs-lookup"><span data-stu-id="22344-266">Using an interface to encapsulate the data access logic in one place can minimize how many places you will have to change when your database changes.</span></span>

### <a name="disposing-of-services"></a><span data-ttu-id="22344-267">Eliminazione dei servizi</span><span class="sxs-lookup"><span data-stu-id="22344-267">Disposing of services</span></span>

<span data-ttu-id="22344-268">Il contenitore chiamerà `Dispose` per `IDisposable` crea tipi.</span><span class="sxs-lookup"><span data-stu-id="22344-268">The container will call `Dispose` for `IDisposable` types it creates.</span></span> <span data-ttu-id="22344-269">Tuttavia, se ci si aggiunge un'istanza per il contenitore, non verrà eliminato.</span><span class="sxs-lookup"><span data-stu-id="22344-269">However, if you add an instance to the container yourself, it will not be disposed.</span></span>

<span data-ttu-id="22344-270">Esempio:</span><span class="sxs-lookup"><span data-stu-id="22344-270">Example:</span></span>

```csharp
// Services implement IDisposable:
public class Service1 : IDisposable {}
public class Service2 : IDisposable {}
public class Service3 : IDisposable {}

public interface ISomeService {}
public class SomeServiceImplementation : ISomeService, IDisposable {}


public void ConfigureServices(IServiceCollection services)
{
    // container will create the instance(s) of these types and will dispose them
    services.AddScoped<Service1>();
    services.AddSingleton<Service2>();
    services.AddSingleton<ISomeService>(sp => new SomeServiceImplementation());

    // container did not create instance so it will NOT dispose it
    services.AddSingleton<Service3>(new Service3());
    services.AddSingleton(new Service3());
}
```

> [!NOTE]
> <span data-ttu-id="22344-271">Nella versione 1.0, il contenitore chiamato dispose su *tutti* `IDisposable` oggetti, inclusi quelli non è stata creata.</span><span class="sxs-lookup"><span data-stu-id="22344-271">In version 1.0, the container called dispose on *all* `IDisposable` objects, including those it did not create.</span></span>

## <a name="replacing-the-default-services-container"></a><span data-ttu-id="22344-272">Sostituendo il contenitore dei servizi predefiniti</span><span class="sxs-lookup"><span data-stu-id="22344-272">Replacing the default services container</span></span>

<span data-ttu-id="22344-273">Il contenitore dei servizi predefiniti è progettato per soddisfare le esigenze di base di framework e la maggior parte delle applicazioni consumer compilate su di esso.</span><span class="sxs-lookup"><span data-stu-id="22344-273">The built-in services container is meant to serve the basic needs of the framework and most consumer applications built on it.</span></span> <span data-ttu-id="22344-274">Tuttavia, gli sviluppatori possono sostituire il contenitore predefinito con il relativo contenitore preferito.</span><span class="sxs-lookup"><span data-stu-id="22344-274">However, developers can replace the built-in container with their preferred container.</span></span> <span data-ttu-id="22344-275">Il `ConfigureServices` metodo in genere restituisce `void`, ma se la firma viene modificata per restituire `IServiceProvider`, un diverso contenitore può essere configurato e restituito.</span><span class="sxs-lookup"><span data-stu-id="22344-275">The `ConfigureServices` method typically returns `void`, but if its signature is changed to return `IServiceProvider`, a different container can be configured and returned.</span></span> <span data-ttu-id="22344-276">Sono disponibili molti contenitori IOC per .NET.</span><span class="sxs-lookup"><span data-stu-id="22344-276">There are many IOC containers available for .NET.</span></span> <span data-ttu-id="22344-277">In questo esempio, il [Autofac](https://autofac.org/) viene utilizzato un pacchetto.</span><span class="sxs-lookup"><span data-stu-id="22344-277">In this example, the [Autofac](https://autofac.org/) package is used.</span></span>

<span data-ttu-id="22344-278">In primo luogo, installare i pacchetti contenitore appropriato:</span><span class="sxs-lookup"><span data-stu-id="22344-278">First, install the appropriate container package(s):</span></span>

* `Autofac`
* `Autofac.Extensions.DependencyInjection`

<span data-ttu-id="22344-279">A questo punto, configurare il contenitore in `ConfigureServices` e restituire un `IServiceProvider`:</span><span class="sxs-lookup"><span data-stu-id="22344-279">Next, configure the container in `ConfigureServices` and return an `IServiceProvider`:</span></span>

```csharp
public IServiceProvider ConfigureServices(IServiceCollection services)
{
    services.AddMvc();
    // Add other framework services

    // Add Autofac
    var containerBuilder = new ContainerBuilder();
    containerBuilder.RegisterModule<DefaultModule>();
    containerBuilder.Populate(services);
    var container = containerBuilder.Build();
    return new AutofacServiceProvider(container);
}
```

> [!NOTE]
> <span data-ttu-id="22344-280">Quando si utilizza un contenitore DI terze parti, è necessario modificare `ConfigureServices` in modo che restituisca `IServiceProvider` anziché `void`.</span><span class="sxs-lookup"><span data-stu-id="22344-280">When using a third-party DI container, you must change `ConfigureServices` so that it returns `IServiceProvider` instead of `void`.</span></span>

<span data-ttu-id="22344-281">Configurare infine Autofac normalmente in `DefaultModule`:</span><span class="sxs-lookup"><span data-stu-id="22344-281">Finally, configure Autofac as normal in `DefaultModule`:</span></span>

```csharp
public class DefaultModule : Module
{
    protected override void Load(ContainerBuilder builder)
    {
        builder.RegisterType<CharacterRepository>().As<ICharacterRepository>();
    }
}
```

<span data-ttu-id="22344-282">In fase di esecuzione Autofac da utilizzare per risolvere i tipi e inserire le dipendenze.</span><span class="sxs-lookup"><span data-stu-id="22344-282">At runtime, Autofac will be used to resolve types and inject dependencies.</span></span> <span data-ttu-id="22344-283">[Ulteriori informazioni sull'utilizzo Autofac e ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span><span class="sxs-lookup"><span data-stu-id="22344-283">[Learn more about using Autofac and ASP.NET Core](http://docs.autofac.org/en/latest/integration/aspnetcore.html).</span></span>

### <a name="thread-safety"></a><span data-ttu-id="22344-284">Thread safety</span><span class="sxs-lookup"><span data-stu-id="22344-284">Thread safety</span></span>

<span data-ttu-id="22344-285">Servizi singleton devono essere thread-safe.</span><span class="sxs-lookup"><span data-stu-id="22344-285">Singleton services need to be thread safe.</span></span> <span data-ttu-id="22344-286">Se un servizio singleton ha una dipendenza da un servizio temporaneo, il servizio temporaneo anche debba essere thread-safe a seconda della modalità di utilizzo per il singleton.</span><span class="sxs-lookup"><span data-stu-id="22344-286">If a singleton service has a dependency on a transient service, the transient service may also need to be thread safe depending how it’s used by the singleton.</span></span>

## <a name="recommendations"></a><span data-ttu-id="22344-287">Suggerimenti</span><span class="sxs-lookup"><span data-stu-id="22344-287">Recommendations</span></span>

<span data-ttu-id="22344-288">Quando si lavora con inserimento di dipendenze, tenere presente quanto segue:</span><span class="sxs-lookup"><span data-stu-id="22344-288">When working with dependency injection, keep the following recommendations in mind:</span></span>

* <span data-ttu-id="22344-289">SEN è per gli oggetti che hanno dipendenze complesse.</span><span class="sxs-lookup"><span data-stu-id="22344-289">DI is for objects that have complex dependencies.</span></span> <span data-ttu-id="22344-290">I controller, servizi, schede e repository sono tutti esempi di oggetti che possono essere aggiunti alla DI.</span><span class="sxs-lookup"><span data-stu-id="22344-290">Controllers, services, adapters, and repositories are all examples of objects that might be added to DI.</span></span>

* <span data-ttu-id="22344-291">Evitare di archiviare i dati e la configurazione direttamente DI.</span><span class="sxs-lookup"><span data-stu-id="22344-291">Avoid storing data and configuration directly in DI.</span></span> <span data-ttu-id="22344-292">Ad esempio, carrello acquisti un utente non deve in genere aggiunto per il contenitore dei servizi.</span><span class="sxs-lookup"><span data-stu-id="22344-292">For example, a user's shopping cart shouldn't typically be added to the services container.</span></span> <span data-ttu-id="22344-293">Configurazione deve usare il [modello opzioni](xref:fundamentals/configuration/options).</span><span class="sxs-lookup"><span data-stu-id="22344-293">Configuration should use the [options pattern](xref:fundamentals/configuration/options).</span></span> <span data-ttu-id="22344-294">Evitare in modo analogo, gli oggetti "contenitore di dati" esistenti solo per consentire l'accesso a un altro oggetto.</span><span class="sxs-lookup"><span data-stu-id="22344-294">Similarly, avoid "data holder" objects that only exist to allow access to some other object.</span></span> <span data-ttu-id="22344-295">È preferibile richiedere l'elemento effettivo necessaria tramite DI, se possibile.</span><span class="sxs-lookup"><span data-stu-id="22344-295">It's better to request the actual item needed via DI, if possible.</span></span>

* <span data-ttu-id="22344-296">Evitare l'accesso ai servizi statico.</span><span class="sxs-lookup"><span data-stu-id="22344-296">Avoid static access to services.</span></span>

* <span data-ttu-id="22344-297">Evitare di posizione del servizio nel codice dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="22344-297">Avoid service location in your application code.</span></span>

* <span data-ttu-id="22344-298">Evitare l'accesso statico a `HttpContext`.</span><span class="sxs-lookup"><span data-stu-id="22344-298">Avoid static access to `HttpContext`.</span></span>

> [!NOTE]
> <span data-ttu-id="22344-299">Ad esempio tutti i set di indicazioni, potrebbero verificarsi situazioni in cui è necessario ignorare uno.</span><span class="sxs-lookup"><span data-stu-id="22344-299">Like all sets of recommendations, you may encounter situations where ignoring one is required.</span></span> <span data-ttu-id="22344-300">Sono stati rilevati eccezioni - rari casi principalmente molto speciali all'interno di framework stesso.</span><span class="sxs-lookup"><span data-stu-id="22344-300">We have found exceptions to be rare -- mostly very special cases within the framework itself.</span></span>

<span data-ttu-id="22344-301">Inserimento di dipendenze è un *alternativo* a criteri di accesso di oggetti statici/globali.</span><span class="sxs-lookup"><span data-stu-id="22344-301">Remember, dependency injection is an *alternative* to static/global object access patterns.</span></span> <span data-ttu-id="22344-302">Non sarà in grado di comprendere i vantaggi delle dipendenze, se possibile combinare con l'accesso agli oggetti statici.</span><span class="sxs-lookup"><span data-stu-id="22344-302">You will not be able to realize the benefits of DI if you mix it with static object access.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="22344-303">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="22344-303">Additional Resources</span></span>

* [<span data-ttu-id="22344-304">Avvio dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="22344-304">Application Startup</span></span>](startup.md)

* [<span data-ttu-id="22344-305">Test</span><span class="sxs-lookup"><span data-stu-id="22344-305">Testing</span></span>](../testing/index.md)

* [<span data-ttu-id="22344-306">Scrittura di codice ottimizzato in ASP.NET Core con l'inserimento di dipendenze (MSDN)</span><span class="sxs-lookup"><span data-stu-id="22344-306">Writing Clean Code in ASP.NET Core with Dependency Injection (MSDN)</span></span>](https://msdn.microsoft.com/magazine/mt703433.aspx)

* [<span data-ttu-id="22344-307">Progettazione di applicazioni di gestire contenitori, preludio: In cui non il contenitore appartenere?</span><span class="sxs-lookup"><span data-stu-id="22344-307">Container-Managed Application Design, Prelude: Where does the Container Belong?</span></span>](https://blogs.msdn.microsoft.com/nblumhardt/2008/12/26/container-managed-application-design-prelude-where-does-the-container-belong/)

* [<span data-ttu-id="22344-308">Principio dipendenze esplicite</span><span class="sxs-lookup"><span data-stu-id="22344-308">Explicit Dependencies Principle</span></span>](http://deviq.com/explicit-dependencies-principle/)

* <span data-ttu-id="22344-309">[Inversione di contenitori di controlli e il criterio di aggiunta della dipendenza](https://www.martinfowler.com/articles/injection.html) (Fowler)</span><span class="sxs-lookup"><span data-stu-id="22344-309">[Inversion of Control Containers and the Dependency Injection Pattern](https://www.martinfowler.com/articles/injection.html) (Fowler)</span></span>
